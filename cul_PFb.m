% === 参数设置 ===
tasks = {'em', 'nb', 'ant', 'bart'};
numConditions = 12;
numSubjects = 842;
numColumns = 12;

% 替换为你的完整行索引和行为变量
rowsToUse = [1,	2,	3,	4,	5,	6,	7,	8,	9,	10,	11,	12,	13,	14,	15,	16,	17,	18,	19,	20,	21,	22,	23,	24,	25,	26,	27,	28,	29,	30,	31,	32,	33,	34,	35,	36,	37,	38,	39,	40,	41,	42,	43,	44,	45,	46,	47,	48,	49,	50,	51,	52,	53,	54,	55,	56,	57,	58,	59,	60,	61,	62,	63,	64,	65,	66,	67,	68,	69,	70,	71,	72,	73,	74,	75,	76,	77,	78,	79,	80,	81,	82,	83,	84,	85,	86,	87,	88,	89,	90,	91,	92,	93,	94,	95,	96,	97,	98,	99,	100,	101,	102,	103,	104,	105,	106,	107,	108,	109,	110,	111,	112,	113,	114,	115,	116,	117,	118,	119,	120,	121,	122,	123,	124,	125,	126,	127,	128,	129,	130,	131,	132,	133,	134,	135,	136,	137,	138,	139,	140,	141,	142,	143,	144,	145,	146,	147,	148,	149,	150,	151,	152,	153,	154,	155,	156,	157,	158,	159,	160,	161,	162,	163,	164,	165,	166,	167,	168,	169,	170,	171,	172,	173,	174,	175,	176,	177,	178,	179,	180,	181,	182,	183,	184,	185,	186,	187,	188,	189,	190,	191,	192,	193,	194,	195,	196,	197,	198,	199,	200,	201,	202,	203,	204,	205,	206,	207,	208,	209,	210,	211,	212,	213,	214,	215,	216,	217,	218,	219,	220,	221,	222,	223,	224,	225,	226,	227,	228,	229,	230,	231,	232,	233,	234,	235,	236,	237,	238,	239,	240,	241,	242,	243,	244,	245,	246,	247,	248,	249,	250,	251,	252,	253,	254,	255,	256,	257,	258,	259,	260,	261,	262,	263,	264,	265,	266,	267,	268,	269,	270,	271,	272,	273,	274,	275,	276,	277,	278,	279,	280,	281,	282,	283,	284,	285,	286,	287,	288,	289,	290,	291,	292,	293,	294,	295,	296,	297,	298,	299,	300,	301,	302,	303,	304,	305,	306,	307,	308,	309,	310,	311,	312,	313,	314,	315,	316,	317,	318,	319,	320,	321,	322,	323,	324,	325,	326,	327,	328,	329,	330,	331,	332,	333,	334,	335,	336,	337,	338,	339,	340,	341,	342,	343,	344,	345,	346,	347,	348,	349,	350,	351,	352,	353,	354,	355,	356,	357,	358,	359,	360,	361,	362,	363,	364,	365,	366,	367,	368,	369,	370,	371,	372,	373,	374,	375,	376,	377,	378,	379,	380,	381,	382,	383,	384,	385,	386,	387,	388,	389,	390,	391,	392,	393,	394,	395,	396,	397,	398,	399,	400,	401,	402,	403,	404,	405,	406,	407,	408,	409,	410,	411,	412,	413,	414,	415,	416,	417,	418,	419,	420,	421,	422,	423,	424,	425,	426,	427,	428,	429,	430,	431,	432,	433,	434,	435,	436,	437,	438,	439,	440,	441,	442,	443,	444,	445,	446,	447,	448,	449,	450,	451,	452,	453,	454,	455,	456,	457,	458,	459,	460,	461,	462,	463,	464,	465,	466,	467,	468,	469,	470,	471,	472,	473,	474,	475,	476,	477,	478,	479,	480,	481,	482,	483,	484,	485,	486,	487,	488,	489,	490,	491,	492,	493,	494,	495,	496,	497,	498,	499,	500,	501,	502,	503,	504,	505,	506,	507,	508,	509,	510,	511,	512,	513,	514,	515,	516,	517,	518,	519,	520,	521,	522,	523,	524,	525,	526,	527,	528,	529,	530,	531,	532,	533,	534,	535,	536,	537,	538,	539,	540,	541,	542,	543,	544,	545,	546,	547,	548,	549,	550,	551,	552,	553,	554,	555,	556,	557,	558,	559,	560,	561,	562,	563,	564,	565,	566,	567,	568,	569,	570,	571,	572,	573,	574,	575,	576,	577,	578,	579,	580,	581,	582,	583,	584,	585,	586,	587,	588,	589,	590,	591,	592,	593,	594,	595,	596,	597,	598,	599,	600,	601,	603,	604,	605,	606,	607,	608,	609,	610,	611,	612,	613,	614,	615,	616,	617,	618,	619,	620,	621,	622,	623,	624,	625,	626,	627,	628,	629,	630,	631,	632,	633,	634,	635,	636,	637,	638,	639,	640,	641,	642,	643,	644,	645,	647,	648,	649,	650,	651,	652,	653,	654,	655,	656,	657,	658,	659,	660,	661,	662,	663,	664,	665,	666,	667,	668,	669,	670,	671,	672,	673,	674,	675,	676,	677,	678,	679,	680,	681,	682,	683,	684,	685,	686,	687,	688,	689,	690,	692,	693,	694,	695,	696,	697,	698,	699,	701,	702,	703,	704,	705,	706,	707,	708,	709,	710,	712,	713,	715,	717,	718,	719,	720,	721,	722,	723,	724,	725,	726,	727,	728,	729,	731,	732,	733,	734,	735,	736,	737,	738,	739,	740,	743,	744,	745,	746,	747,	748,	749,	750,	751,	752,	754,	755,	756,	758,	759,	760,	761,	762,	763,	764,	765,	766,	767,	769,	770,	771,	772,	773,	775,	777,	779,	780,	781,	782,	783,	784,	785,	786,	787,	788,	789,	790,	792,	793,	794,	795,	796,	797,	798,	799,	800,	801,	802,	803,	804,	805,	806,	807,	808,	809,	810,	811,	812,	813,	814,	815,	816,	817,	818,	820,	821,	822,	823,	824,	825,	826,	827,	828,	829,	830,	831,	832,	833,	834,	835,	836,	837,	838,	839,	840,	841,	842,
]; % 使用完整的行索引列表替换省略号

% 指定要计算相关性的列值
columnValues = [0.2345,	0.2717,	0.2556,	0.3221,	0.2145,	0.2885,	0.2694,	0.2245,	0.2781,	0.3044,	0.2651,	0.2936,	0.2883,	0.2035,	0.2646,	0.2225,	0.2021,	0.2771,	0.2992,	0.3217,	0.2967,	0.3058,	0.325,	0.1779,	0.2596,	0.3112,	0.2838,	0.2801,	0.3118,	0.2555,	0.2703,	0.2742,	0.1699,	0.2577,	0.2942,	0.2552,	0.2243,	0.218,	0.2219,	0.2706,	0.2658,	0.2498,	0.223,	0.2529,	0.2999,	0.2889,	0.3008,	0.1811,	0.2968,	0.2694,	0.1828,	0.2441,	0.2369,	0.2333,	0.2734,	0.2826,	0.2979,	0.2896,	0.2894,	0.328,	0.2598,	0.2899,	0.3063,	0.2961,	0.2961,	0.1484,	0.2917,	0.2414,	0.1954,	0.2069,	0.2417,	0.2727,	0.2558,	0.1609,	0.2524,	0.2845,	0.1735,	0.2077,	0.2777,	0.199,	0.175,	0.1179,	0.2435,	0.2766,	0.3101,	0.2039,	0.1534,	0.2845,	0.2872,	0.3069,	0.2891,	0.2755,	0.2552,	0.2505,	0.2635,	0.2424,	0.2654,	0.2819,	0.2689,	0.2621,	0.2638,	0.2914,	0.251,	0.1355,	0.2742,	0.2538,	0.3016,	0.243,	0.3057,	0.2479,	0.286,	0.2104,	0.2574,	0.2516,	0.3108,	0.2711,	0.2615,	0.2416,	0.2661,	0.2476,	0.2353,	0.2714,	0.2993,	0.2347,	0.2535,	0.308,	0.1377,	0.1933,	0.2205,	0.2904,	0.1364,	0.2135,	0.211,	0.2328,	0.2582,	0.3132,	0.199,	0.2393,	0.19,	0.2468,	0.2711,	0.205,	0.2523,	0.2172,	0.2005,	0.2923,	0.2563,	0.2535,	0.2089,	0.2298,	0.2244,	0.2899,	0.2733,	0.2039,	0.255,	0.2138,	0.2762,	0.2168,	0.2849,	0.2886,	0.2686,	0.227,	0.2817,	0.2653,	0.3466,	0.2746,	0.2928,	0.2596,	0.2128,	0.2665,	0.2948,	0.2644,	0.2747,	0.2666,	0.3051,	0.2197,	0.302,	0.2714,	0.249,	0.2043,	0.1466,	0.2714,	0.2807,	0.2915,	0.2684,	0.2341,	0.2643,	0.2633,	0.2682,	0.2618,	0.2515,	0.1719,	0.2983,	0.2752,	0.2509,	0.2491,	0.2895,	0.3137,	0.2919,	0.2183,	0.2203,	0.3063,	0.2885,	0.2455,	0.2451,	0.2883,	0.2715,	0.2797,	0.2779,	0.1862,	0.3384,	0.2609,	0.3003,	0.2373,	0.2804,	0.2534,	0.2548,	0.2904,	0.1687,	0.2315,	0.2268,	0.2861,	0.2419,	0.2664,	0.2062,	0.2697,	0.2769,	0.2503,	0.2125,	0.2588,	0.2801,	0.2966,	0.2519,	0.2201,	0.2907,	0.258,	0.222,	0.2291,	0.2537,	0.2247,	0.2658,	0.2284,	0.3025,	0.2011,	0.2137,	0.3076,	0.2788,	0.2565,	0.2718,	0.2584,	0.2913,	0.2318,	0.3041,	0.2676,	0.2876,	0.2439,	0.2719,	0.2291,	0.2509,	0.234,	0.2892,	0.2823,	0.2127,	0.284,	0.2814,	0.2208,	0.2681,	0.2735,	0.1967,	0.2239,	0.2742,	0.2634,	0.2607,	0.1816,	0.3099,	0.1816,	0.2928,	0.2805,	0.2699,	0.3234,	0.2427,	0.2418,	0.2574,	0.2919,	0.2604,	0.2985,	0.296,	0.3013,	0.2805,	0.279,	0.2826,	0.2859,	0.3102,	0.2333,	0.2632,	0.2692,	0.2628,	0.261,	0.2577,	0.2449,	0.2366,	0.2135,	0.2681,	0.3109,	0.2802,	0.1359,	0.2758,	0.3148,	0.2477,	0.2308,	0.2705,	0.2285,	0.2766,	0.2778,	0.2783,	0.2528,	0.2862,	0.2365,	0.2319,	0.1774,	0.2634,	0.2895,	0.2711,	0.2864,	0.1184,	0.2623,	0.2188,	0.1813,	0.2379,	0.2518,	0.2633,	0.2532,	0.2143,	0.2424,	0.2683,	0.2782,	0.2725,	0.2769,	0.2317,	0.2589,	0.2068,	0.2624,	0.2382,	0.2759,	0.2795,	0.1871,	0.2142,	0.2175,	0.2604,	0.2496,	0.2499,	0.254,	0.2869,	0.2734,	0.2872,	0.2948,	0.2812,	0.3135,	0.2579,	0.2805,	0.239,	0.2257,	0.2842,	0.2395,	0.2604,	0.1979,	0.2552,	0.3137,	0.2748,	0.3068,	0.2546,	0.2702,	0.2812,	0.2548,	0.2322,	0.2914,	0.2689,	0.2823,	0.2986,	0.2498,	0.2795,	0.2939,	0.2196,	0.3098,	0.2575,	0.2718,	0.3046,	0.2345,	0.2205,	0.1882,	0.2682,	0.1718,	0.2402,	0.2646,	0.2997,	0.2536,	0.3379,	0.2524,	0.2797,	0.2666,	0.2585,	0.26,	0.2564,	0.1878,	0.266,	0.2691,	0.2349,	0.2372,	0.2656,	0.2771,	0.2514,	0.2692,	0.2855,	0.259,	0.3081,	0.2898,	0.29,	0.3098,	0.2711,	0.246,	0.2593,	0.2931,	0.1662,	0.3083,	0.2609,	0.2841,	0.2933,	0.2417,	0.2854,	0.3384,	0.2756,	0.2912,	0.2343,	0.2477,	0.2472,	0.1729,	0.2744,	0.2616,	0.2153,	0.2618,	0.2825,	0.2736,	0.2856,	0.2603,	0.2867,	0.2698,	0.2843,	0.2566,	0.2699,	0.1672,	0.3036,	0.2248,	0.2257,	0.2806,	0.2569,	0.267,	0.2431,	0.2636,	0.2804,	0.1964,	0.2128,	0.3041,	0.2762,	0.2887,	0.2955,	0.2437,	0.2746,	0.3562,	0.2139,	0.3323,	0.2541,	0.2535,	0.2578,	0.275,	0.3114,	0.2576,	0.316,	0.2549,	0.2831,	0.2983,	0.296,	0.2799,	0.3057,	0.3026,	0.3353,	0.3269,	0.2386,	0.2938,	0.2624,	0.2987,	0.2883,	0.2145,	0.2235,	0.2183,	0.2639,	0.3097,	0.2744,	0.2925,	0.265,	0.2294,	0.2313,	0.2141,	0.2842,	0.2786,	0.2544,	0.3212,	0.3082,	0.3066,	0.206,	0.2784,	0.2924,	0.2891,	0.2683,	0.2907,	0.2446,	0.2552,	0.2615,	0.262,	0.238,	0.2852,	0.2477,	0.2504,	0.3049,	0.3172,	0.2703,	0.2602,	0.2336,	0.2877,	0.2925,	0.2487,	0.2798,	0.2671,	0.2751,	0.2662,	0.2913,	0.3087,	0.3196,	0.2726,	0.2808,	0.3361,	0.2187,	0.2289,	0.2727,	0.3014,	0.2556,	0.2855,	0.2763,	0.2977,	0.2669,	0.2748,	0.2873,	0.2516,	0.2336,	0.2757,	0.3051,	0.293,	0.2795,	0.2303,	0.1133,	0.2841,	0.323,	0.2905,	0.258,	0.2336,	0.158,	0.2466,	0.2729,	0.2847,	0.1513,	0.1473,	0.2104,	0.2765,	0.3116,	0.2321,	0.2697,	0.2456,	0.2594,	0.2383,	0.1877,	0.2415,	0.2656,	0.2665,	0.2731,	0.2796,	0.2526,	0.2333,	0.2477,	0.2378,	0.3348,	0.2688,	0.2486,	0.2418,	0.2876,	0.2967,	0.2524,	0.2579,	0.2708,	0.2393,	0.2377,	0.3272,	0.2723,	0.2353,	0.2756,	0.2359,	0.2605,	0.2368,	0.2852,	0.2631,	0.3057,	0.3093,	0.2433,	0.2482,	0.2963,	0.2808,	0.2383,	0.2584,	0.2279,	0.2182,	0.2985,	0.3127,	0.2843,	0.2828,	0.2574,	0.2636,	0.2552,	0.1888,	0.2274,	0.2469,	0.2957,	0.2877,	0.2171,	0.3311,	0.2598,	0.214,	0.2368,	0.253,	0.1819,	0.1657,	0.2992,	0.2843,	0.2837,	0.28,	0.2758,	0.2897,	0.1243,	0.2444,	0.2957,	0.2358,	0.268,	0.1933,	0.2812,	0.274,	0.2704,	0.2827,	0.239,	0.2711,	0.3024,	0.2168,	0.2722,	0.267,	0.2594,	0.3036,	0.2619,	0.2729,	0.2655,	0.2515,	0.2599,	0.2856,	0.287,	0.3026,	0.3009,	0.3054,	0.2861,	0.2731,	0.2758,	0.2235,	0.1629,	0.205,	0.2331,	0.1922,	0.2855,	0.1274,	0.2636,	0.284,	0.3105,	0.2629,	0.2674,	0.2417,	0.2864,	0.2471,	0.2379,	0.2337,	0.2185,	0.2528,	0.2745,	0.2637,	0.2973,	0.2809,	0.2843,	0.2606,	0.2974,	0.3132,	0.2581,	0.2778,	0.2916,	0.2361,	0.1863,	0.2129,	0.3093,	0.2871,	0.2682,	0.2584,	0.2698,	0.28,	0.2287,	0.2536,	0.261,	0.2761,	0.268,	0.1507,	0.254,	0.2602,	0.2861,	0.2758,	0.265,	0.2977,	0.3278,	0.2562,	0.2945,	0.2888,	0.2626,	0.2769,	0.2435,	0.2723,	0.2431,	0.2451,	0.3028,	0.3207,	0.3107,	0.2665,	0.2756,	0.2787,	0.2751,	0.2586,	0.2753,	0.3074,	0.2761,	0.2404,	0.2768,	0.2495,	0.2403,	0.2488,	0.2564,	0.3124,	0.2772,	0.2801,	0.3048,	0.2748,	0.2692,	0.2803,	0.2526,	0.2104,	0.2544,	0.2537,	0.2988,	0.2832,	0.288,	0.2598,	0.2632,	0.28,	0.2557,	0.236,	0.2789,	0.2407,	0.2336,	0.2589,	0.2511,	0.2945,	0.2449,	0.2025,	0.3088,	0.2198,	0.3003,	0.2997,	0.1478,	0.1585,	0.281,	0.3049,	0.2629,	0.2766,	0.3012,	0.2959,	0.2692,	0.2863,	0.2763,	0.2434,	0.2439,	0.2632,	0.2345,	0.2876,	0.1652,	0.2295,	0.2885,	0.2578,	0.3058,	0.2925,	0.1936,	0.2504,	0.2684,	0.2098,	0.2745,	0.2904,	0.2869,	0.2843,	0.2582,	0.3231,	0.317,	0.2752,	0.3051,	0.2834,	0.3067,	0.284,	0.2401,	0.2808]; % 使用完整的列值列表替换省略号

% Excel 文件名
excelFileName = 'discrepancyCorrelationResults.xlsx';
summaryFileName = 'summaryVectors.xlsx';

% 删除旧文件以防sheet重复
if exist(excelFileName, 'file'); delete(excelFileName); end
if exist(summaryFileName, 'file'); delete(summaryFileName); end

% 初始化 summary 向量存储
summaryLabels = {};
summaryVectors = {};

% 处理每个任务
for t = 1:length(tasks)
    taskName = tasks{t};
    
    resultsCorr = zeros(numConditions, numColumns);
    resultsPVal = zeros(numConditions, numColumns);
    
    for n = 1:numConditions
        % 加载对应文件
        filename = sprintf('condition_%d_discrepancyCoefficients%s.mat', n, taskName);
        loadedData = load(filename, 'conditionDiscrepancies');
        conditionData = loadedData.conditionDiscrepancies;
        
        for col = 1:numColumns
            rowData = conditionData(rowsToUse, col);
            validIdx = ~isnan(rowData);
            validRowData = rowData(validIdx);
            validColValues = columnValues(validIdx);
            
            if ~isempty(validRowData) && length(validRowData) > 1
                [R, P] = corrcoef(validRowData, validColValues);
                if size(R,1) > 1 && size(R,2) > 1
                    resultsCorr(n, col) = R(1,2);
                    resultsPVal(n, col) = P(1,2);
                end
            end
        end
    end
    
    % 写入主Excel
    writematrix(resultsCorr, excelFileName, 'Sheet', sprintf('%s_R', taskName));
    writematrix(resultsPVal, excelFileName, 'Sheet', sprintf('%s_P', taskName));
    
    % === 提取指定行 ===
    groupA_rows = [1,2,3,4,7,12];
    groupB_rows = [5,6,8,9,10,11];
    
    groupA_R = reshape(resultsCorr(groupA_rows, :), [], 1);
    groupB_R = reshape(resultsCorr(groupB_rows, :), [], 1);
    groupA_P = reshape(resultsPVal(groupA_rows, :), [], 1);
    groupB_P = reshape(resultsPVal(groupB_rows, :), [], 1);
    
    % 保存为 cell 便于最后批量写入
    summaryVectors{end+1} = groupA_R; summaryLabels{end+1} = sprintf('%s_R_GroupA', taskName);
    summaryVectors{end+1} = groupB_R; summaryLabels{end+1} = sprintf('%s_R_GroupB', taskName);
    summaryVectors{end+1} = groupA_P; summaryLabels{end+1} = sprintf('%s_P_GroupA', taskName);
    summaryVectors{end+1} = groupB_P; summaryLabels{end+1} = sprintf('%s_P_GroupB', taskName);
end

% === 写入汇总向量到 summary Excel ===
for i = 1:length(summaryVectors)
    label = summaryLabels{i};
    vec = summaryVectors{i};
    writematrix(vec, summaryFileName, 'Sheet', label);
end

disp('✅ 所有分析完成，两个Excel文件已保存。');
